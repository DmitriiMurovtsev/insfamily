{% extends 'main/base.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'agents/css/issuance_bso.css' %}">

<div class="pop_up" id="1">
    <div class="pop_up_container">
        <div class="pop_up_body">
            <form class="issuance_bso" method="post">
            {% csrf_token %}
                <table>
                    <tr>
                        <td>Агент:</td>
                        <td>
                            <select name="agent" id="">
                            {% for agent in agents %}
                            <option value="{{ agent.id }}">{{ agent }}</option>
                            {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Компания:</td>
                        <td>
                            <select name="company">
                            {% for company in company %}
                            <option value="{{ company.id }}">{{ company }}</option>
                            {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td>Серия:</td>
                        <td>
                            <input type="text" name="series">
                        </td>
                    </tr>
                    <tr>
                        <td>Номер:</td>
                        <td>
                            <input type="text" name="number">
                        </td>
                    </tr>
                    <tr>
                        <td>Диапазон:</td>
                        <td>
                            <input type="number" value="1" name="range">
                        </td>
                    </tr>
                    <tr>
                        <td>Дата получения от СК: </td>
                        <td>
                            <input type="date" name="date_add" value="{{ date_now }}">
                        </td>
                    </tr>
                    <tr>
                        <td>Дата выдачи агенту: </td>
                        <td>
                            <input type="date" name="date_at" value="{{ date_now }}">
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <button class="button">Выдать</button>
                        </td>
                    </tr>
                </table>
            </form>
            <div class="pop_up_close" data-close="1">&#10006</div>
        </div>
    </div>
</div>

<table>
    <tr>
        <td>
            <form action="" method="get">
                <select name="agent">
                    <option value="all">Все</option>
                    {% for agent in agents %}
                    {% if selected.agent == agent.id %}
                    <option value="{{ agent.id }}" selected>{{ agent }}</option>
                    {% else %}
                    <option value="{{ agent.id }}">{{ agent }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
                <select name="shelf_life">
                    {% if selected.shelf_life == 'suitable' %}
                    <option value="all">Любой срок</option>
                    <option value="suitable" selected>Подходящие</option>
                    <option value="overdue">Просроченные</option>
                    {% elif selected.shelf_life == 'overdue' %}
                    <option value="all">Любой срок</option>
                    <option value="suitable">Подходящие</option>
                    <option value="overdue" selected>Просроченные</option>
                    {% else %}
                    <option value="all">Любой срок</option>
                    <option value="suitable">Подходящие</option>
                    <option value="overdue">Просроченные</option>
                    {% endif %}
                </select>
            <button class="button">Просмотр</button>
            </form>
        </td>
        <td>
            <form action="" method="get">
            <input type="text" name="search">
            <button class="button">Найти</button>
            {{ text_search }}
            </form>
        </td>
        <td>
            <div class="button" data-path="1">
    <a href="#">Выдать БСО</a>
</div>
        </td>
        <td>
            {{ text_bso }}
            {% if text_errors_bso != 0 %}
                {{ text_errors_bso }}
            {% endif %}
        </td>
    </tr>
</table>

<table class="table_2">
    <tr>
        <th>Агент</th>
        <th>Серия</th>
        <th>Номер</th>
        <th>Дата получения от СК</th>
        <th>Дата выдачи агенту</th>
    </tr>
    {% for bso in bso %}
    <tr id="{{ bso.id }}">
        <td>{{ bso.agent }}</td>
        <td>{{ bso.series }}</td>
        <td>{{ bso.number }}</td>
        <td>{{ bso.date_add }}</td>
        <td class="date-at" data-path="{{ bso.id }}" storage_time="{{ bso.agent.storage_time }}">{{ bso.date_at }}</td>
    </tr>
    {% endfor %}
</table>

<br>---<br>

{% if page.has_previous %}
    <a href="{{ link }}page={{ page.previous_page_number }}" class="button">Назад</a>
{% endif %}

{% for p in paginator.page_range %}
    {% if p != page.number %}
        <a href="{{ link }}page={{ p }}" class="button">{{ p }}</a>
    {% else %}
        <b class="button check">{{ p }}</b>
    {% endif %}
{% endfor %}

{% if page.has_next %}
    <a href="{{ link }}page={{ page.next_page_number }}" class="button">Далее</a>
{% endif %}

<script>
    const dateAt = document.querySelectorAll('.date-at');
    var i = 0;
    for (i = 0; i < dateAt.length; ++i) {
        day = dateAt[i].textContent.slice(0, 2);
        if (dateAt[i].textContent.slice(3, 6) == 'янв'){
            month = 00;
            year = dateAt[i].textContent.slice(10, 14);
        }
        if (dateAt[i].textContent.slice(3, 6) == 'фев'){
            month = 01;
            year = dateAt[i].textContent.slice(11, 15);
        }
        if (dateAt[i].textContent.slice(3, 6) == 'мар'){
            month = 02;
            year = dateAt[i].textContent.slice(6, 10);
        }
        if (dateAt[i].textContent.slice(3, 6) == 'апр'){
            month = 03;
            year = dateAt[i].textContent.slice(10, 14);
        }
        if (dateAt[i].textContent.slice(3, 6) == 'мая'){
            month = 04;
            year = dateAt[i].textContent.slice(7, 11);
        }
        if (dateAt[i].textContent.slice(3, 6) == 'июн'){
            month = 05;
            year = dateAt[i].textContent.slice(8, 12);
        }
        if (dateAt[i].textContent.slice(3, 6) == 'июл'){
            month = 06;
            year = dateAt[i].textContent.slice(8, 12);
        }
        if (dateAt[i].textContent.slice(3, 6) == 'авг'){
            month = 07;
            year = dateAt[i].textContent.slice(11, 15);
        }
        if (dateAt[i].textContent.slice(3, 6) == 'сен'){
            month = 08;
            year = dateAt[i].textContent.slice(11, 15);
        }
        if (dateAt[i].textContent.slice(3, 6) == 'окт'){
            month = 09;
            year = dateAt[i].textContent.slice(11, 15);
        }
        if (dateAt[i].textContent.slice(3, 6) == 'ноя'){
            month = 10;
            year = dateAt[i].textContent.slice(10, 14);
        }
        if (dateAt[i].textContent.slice(3, 6) == 'дек'){
            month = 11;
            year = dateAt[i].textContent.slice(11, 15);
        }

        dateAtAgent = new Date(year, month, day);
        dateNow = new Date();
        storageTime = dateAt[i].getAttribute('storage_time');
        dateRange = Math.ceil(Math.abs(dateNow.getTime() - dateAtAgent.getTime()) / (1000 * 2400 * 60));

        if ((storageTime - dateRange) <= 2) {
            let path = dateAt[i].getAttribute('data-path');
            document.getElementById(path).classList.add('orange');
        }
        if ((storageTime - dateRange) <= 0) {
            let path = dateAt[i].getAttribute('data-path');
            document.getElementById(path).classList.add('red');
            document.getElementById(path).classList.remove('orange');
        }
    }
</script>
<script>
    const openPopUp = document.querySelectorAll('.button');
    const closePopUp = document.querySelectorAll('.pop_up_close');
    const popUp = document.querySelectorAll('.pop_up');

    openPopUp.forEach((el) => {
        el.addEventListener("click", (e) => {
            let path = e.currentTarget.getAttribute('data-path');

            popUp.forEach((el) => {
                el.classList.remove('active');
            })

            document.getElementById(path).classList.add('active');
        });
    });

    closePopUp.forEach((el) => {
        el.addEventListener("click", (e) => {
            let path = e.currentTarget.getAttribute('data-close');
            document.getElementById(path).classList.remove('active');
        });
    });
</script>

{% endblock %}
{% block title %}
    InsFamily - Добавление агента
{% endblock %}